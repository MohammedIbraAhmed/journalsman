# Story 1.2: NextAuth v5 Multi-Provider Configuration

## Status

Ready for Review

## Story

**As a** academic user (author, reviewer, editor),
**I want** to authenticate using Google or ORCID accounts with secure session management,
**so that** I can access the Synfind platform using my preferred academic credentials while maintaining security and user experience standards.

## Acceptance Criteria

1. [ ] Google OAuth integration with academic email domain validation
2. [ ] ORCID OAuth integration for researcher authentication
3. [ ] Secure session management with database session storage
4. [ ] Automatic account linking for users with multiple auth methods
5. [ ] Sign-out functionality with session cleanup
6. [ ] Authentication state management across app

## Tasks / Subtasks

- [x] Install and configure NextAuth v5 (AC: 1, 2, 3)
  - [x] Install NextAuth v5 and required adapters
  - [x] Configure NextAuth with MongoDB session adapter
  - [x] Set up environment variables for auth providers
  - [x] Configure NextAuth API routes in app/api/auth
- [x] Implement Google OAuth provider (AC: 1)
  - [x] Create Google OAuth application configuration
  - [x] Configure Google provider in NextAuth config
  - [x] Add academic email domain validation logic
  - [x] Test Google authentication flow setup
- [x] Implement ORCID OAuth provider (AC: 2)
  - [x] Configure ORCID OAuth provider
  - [x] Configure ORCID provider in NextAuth config
  - [x] Handle ORCID-specific scopes and data
  - [x] Test ORCID authentication flow setup
- [x] Configure database session storage (AC: 3)
  - [x] Set up MongoDB collections for sessions, accounts, users
  - [x] Configure MongoDB adapter for NextAuth
  - [x] Test session persistence configuration
  - [x] Implement session cleanup for expired sessions
- [x] Implement account linking (AC: 4)
  - [x] Configure NextAuth to link accounts with same email
  - [x] Handle account linking edge cases
  - [x] Test multi-provider account linking
  - [x] Add UI for managing linked accounts
- [x] Create authentication UI components (AC: 5, 6)
  - [x] Create SignIn component with provider buttons
  - [x] Create SignOut component with session cleanup
  - [x] Implement authentication state hooks
  - [x] Add loading states for auth operations
- [x] Add authentication middleware (AC: 6)
  - [x] Create Next.js middleware for route protection
  - [x] Implement authentication state management
  - [x] Add redirect logic for authenticated/unauthenticated users
  - [x] Test authentication state persistence

## Dev Notes

### Authentication Requirements

[Source: docs/prd.md - FR1]

- Multi-factor authentication via NextAuth v5 with Google, ORCID, and institutional SSO
- Target >99% sign-on success rate
- Academic-focused authentication with ORCID integration for researchers

### Technology Stack

[Source: docs/architecture/tech-stack.md]

- **Authentication:** NextAuth.js v5 for multi-provider authentication
- **Database:** MongoDB Atlas for session storage
- **Framework:** Next.js 15 with App Router

### Data Models

[Source: docs/architecture/data-models.md]

- User model with authentication provider linking
- Publisher association for multi-tenant access
- Session management for secure state persistence

### Project Structure

[Source: docs/architecture/unified-project-structure.md]
Authentication files location:

```
apps/web/src/
├── app/
│   ├── api/auth/[...nextauth]/
│   └── (auth)/                 # Authentication routes
├── components/
│   └── auth/                   # Authentication UI components
├── lib/
│   ├── auth/                   # Authentication utilities
│   └── config/                 # NextAuth configuration
```

### Coding Standards

[Source: docs/architecture/coding-standards.md]

- Environment variables accessed through packages/shared/config
- Type definitions in packages/shared/types
- Consistent error handling patterns
- Multi-tenant database queries with publisherId filtering

### Security Requirements

- CSRF protection enabled by default in NextAuth v5
- Secure session cookies with httpOnly and secure flags
- Session rotation on authentication
- Email verification for account linking

### Academic Integration

- ORCID provider configuration for researcher authentication
- Academic email domain validation (_.edu, _.ac.uk, etc.)
- Support for institutional SSO in future iterations

### Previous Story Insights

- Database connection and basic project structure established in Story 1.1
- MongoDB Atlas configuration available for session storage
- TypeScript and tRPC foundation ready for type-safe auth integration

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Test Location:** apps/web/tests/integration/auth.test.tsx
- **Testing Framework:** Vitest + Testing Library for auth component testing
- **Mock Requirements:** Mock NextAuth providers for testing
- **Coverage Areas:**
  - Authentication provider integration
  - Session management and persistence
  - Account linking functionality
  - Authentication state management
  - Route protection middleware

### Specific Test Cases

- Successful Google OAuth flow
- Successful ORCID OAuth flow
- Account linking for same email addresses
- Session persistence across page reloads
- Sign-out with proper session cleanup
- Academic email domain validation
- Authentication middleware route protection

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-09-02 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

claude-opus-4-1-20250805 (James - Full Stack Developer)

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

- ✅ **NextAuth v5 Configuration**: Successfully implemented NextAuth v5 with MongoDB adapter and database session storage
- ✅ **Google OAuth Provider**: Configured with academic email domain validation (.edu, .ac.uk, etc.)
- ✅ **ORCID OAuth Provider**: Custom provider implementation for researcher authentication with ORCID ID persistence
- ✅ **Database Session Storage**: MongoDB sessions, accounts, and users collections configured via MongoDBAdapter
- ✅ **Account Linking**: Automatic linking for accounts with same email address across providers
- ✅ **Authentication UI**: SignIn/SignOut buttons, UserProfile component with loading states
- ✅ **Route Protection**: Middleware for protecting /dashboard, /profile routes and API endpoints
- ✅ **Session Management**: 30-day sessions with 24-hour update intervals and secure cookies
- ✅ **Type Safety**: Extended session types with ORCID support and proper TypeScript integration

### File List

**Authentication Configuration:**
- `src/lib/auth/config.ts` - NextAuth v5 configuration with Google/ORCID providers
- `src/lib/auth/index.ts` - Auth exports and utilities
- `src/app/api/auth/[...nextauth]/route.ts` - NextAuth API route handler

**Authentication UI Components:**
- `src/components/auth/SignInButton.tsx` - Provider sign-in buttons with loading states
- `src/components/auth/SignOutButton.tsx` - Sign-out button with session cleanup
- `src/components/auth/UserProfile.tsx` - User profile display with ORCID support
- `src/components/providers/session-provider.tsx` - SessionProvider wrapper

**Authentication Pages:**
- `src/app/(auth)/auth/signin/page.tsx` - Sign-in page with provider selection
- `src/app/(auth)/auth/error/page.tsx` - Authentication error handling page

**Middleware & Protection:**
- `src/middleware.ts` - Route protection and authentication middleware

**Type Definitions:**
- `packages/shared/src/types/index.ts` - Extended User, Account, Session, SessionUser types

**Configuration Updates:**
- `src/app/layout.tsx` - Added AuthProvider to app layout
- `src/app/page.tsx` - Updated homepage with authentication status
- `apps/web/.env.local.example` - Added OAuth provider configuration examples

## QA Results

_Results from QA Agent review will be populated here after story completion_
